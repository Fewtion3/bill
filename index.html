<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏¥‡∏•‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url('399256514_1018582459584603_151014574961731545_n.jpg') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }

    .gui-container {
      background: rgba(255, 255, 255, 1);
      padding: 40px 60px;
      border-radius: 20px;
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 600px;
      width: 100%;
      color: #333;
      overflow-y: auto;
      max-height: 95vh;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: #2575fc;
      font-weight: 700;
    }

    p.description {
      font-size: 1.2rem;
      margin-bottom: 2rem;
      color: #555;
    }

    .button-container, .small-button-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .price-button {
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      border: none;
      border-radius: 12px;
      color: white;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 15px rgba(37, 117, 252, 0.3);
      transition: all 0.3s ease;
    }

    .price-button:hover {
      background: linear-gradient(135deg, #2575fc, #6a11cb);
      transform: translateY(-3px);
    }

    .small-button {
      background-color: #2575fc;
      border: none;
      border-radius: 8px;
      color: white;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 6px 12px rgba(37, 117, 252, 0.4);
      transition: background-color 0.3s ease, transform 0.3s ease;
    }

    .small-button:hover {
      background-color: #1a54b8;
      transform: translateY(-2px);
    }

    #bill-form {
      display: none;
      text-align: left;
      margin-top: 20px;
    }

    #bill-form input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    #bills-display {
      text-align: left;
      margin-top: 20px;
      display: none;
      max-height: 300px;
      overflow-y: auto;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }

    .bill-item {
      background: #f3f6ff;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      position: relative;
    }

    .bill-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .clear-button {
      margin-top: 10px;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="gui-container">
    <h1>‡∏£‡∏∞‡∏ö‡∏ö ‡∏ö‡∏¥‡∏•‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤</h1>
    <p class="description">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>

    <div class="button-container">
      <button type="button" class="price-button" onclick="filterByRent(1600)">‡∏£‡∏≤‡∏Ñ‡∏≤ 1600 ‡∏ö‡∏≤‡∏ó</button>
      <button type="button" class="price-button" onclick="filterByRent(1800)">‡∏£‡∏≤‡∏Ñ‡∏≤ 1800 ‡∏ö‡∏≤‡∏ó</button>
      <button type="button" class="price-button" onclick="filterByRent(2000)">‡∏£‡∏≤‡∏Ñ‡∏≤ 2000 ‡∏ö‡∏≤‡∏ó</button>
      <button type="button" class="price-button" onclick="filterByRent(2200)">‡∏£‡∏≤‡∏Ñ‡∏≤ 2200 ‡∏ö‡∏≤‡∏ó</button>
      <button type="button" class="price-button" onclick="filterByRent(2500)">‡∏£‡∏≤‡∏Ñ‡∏≤ 2500 ‡∏ö‡∏≤‡∏ó</button>
      <button type="button" class="price-button" onclick="filterByRent(3000)">‡∏£‡∏≤‡∏Ñ‡∏≤ 3000 ‡∏ö‡∏≤‡∏ó</button>
      <button type="button" class="price-button" onclick="filterByRent(3500)">‡∏£‡∏≤‡∏Ñ‡∏≤ 3500 ‡∏ö‡∏≤‡∏ó</button>
    </div>

    <div class="small-button-container">
      <button type="button" class="small-button" onclick="showForm()">‡∏Å‡∏£‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡∏´‡∏≠‡∏û‡∏±‡∏Å</button>
      <button type="button" class="small-button" onclick="showBills()">‡∏î‡∏π‡∏ö‡∏¥‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</button>
      <button type="button" class="small-button" onclick="compareElectricity()">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü</button>
    </div>

    <form id="bill-form" onsubmit="saveBill(event)">
      <input type="text" id="room" placeholder="‡∏´‡πâ‡∏≠‡∏á" required />
      <input type="text" id="tenant" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤" required />
      <input type="number" id="rent" placeholder="‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á (‡∏ö‡∏≤‡∏ó)" required />
      <input type="number" id="water" placeholder="‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ (‡∏ö‡∏≤‡∏ó)" required />
      <input type="number" id="electric" placeholder="‡πÉ‡∏ä‡πâ‡πÑ‡∏ü (‡∏´‡∏ô‡πà‡∏ß‡∏¢)" required />
      <input type="number" id="cleaning" placeholder="‡∏Ñ‡πà‡∏≤‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î" required />
      <input type="number" id="other" placeholder="‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ" required />
      <button type="submit" class="small-button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•</button>
    </form>

    <div id="bills-display"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        getDoc, 
        deleteDoc, 
        doc, 
        updateDoc,
        orderBy,
        query
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // **1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase/Firestore (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)**
    const firebaseConfig = {
        apiKey: "AIzaSyA3cyOB17I-p-PGgUCSduXgwsREajZBSiU",
        authDomain: "bill-puttharaksa.firebaseapp.com",
        projectId: "bill-puttharaksa",
        storageBucket: "bill-puttharaksa.appspot.com",
        messagingSenderId: "645837893122",
        appId: "1:645837893122:web:cce76dbff19d960c33811b",
        measurementId: "G-X0EWMS7H3J"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const billsCollection = collection(db, "bills"); // ‡∏ä‡∏∑‡πà‡∏≠ Collection ‡πÉ‡∏ô Firestore

    let editingId = null; // ‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö document ID ‡∏Ç‡∏≠‡∏á Firestore ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ Firestore) ---

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
    window.showForm = function() {
        document.getElementById("bill-form").reset();
        editingId = null;
        document.querySelector("#bill-form button[type='submit']").textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•";
        document.getElementById("bill-form").style.display = "block";
        document.getElementById("bills-display").style.display = "none";
        document.getElementById("rent").value = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤
    }

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏¥‡∏•
    window.showBills = function() {
        document.getElementById("bill-form").style.display = "none";
        displayBills();
    }

    // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤
    window.filterByRent = function(price) {
        document.getElementById("bill-form").style.display = "none";
        displayBills(price);
    }
    
    // 5. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏¥‡∏•‡πÉ‡∏ô Firestore
    window.saveBill = async function(event) {
        event.preventDefault();
        const today = new Date();
        const timestamp = today.getTime(); // ‡πÉ‡∏ä‡πâ timestamp ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
        const formattedDate = today.toLocaleDateString('th-TH', { year: 'numeric', month: '2-digit', day: '2-digit' });
        const formattedTime = today.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

        const billData = {
            room: document.getElementById("room").value,
            tenant: document.getElementById("tenant").value,
            rent: parseFloat(document.getElementById("rent").value),
            water: parseFloat(document.getElementById("water").value),
            electric: parseFloat(document.getElementById("electric").value),
            cleaning: parseFloat(document.getElementById("cleaning").value),
            other: parseFloat(document.getElementById("other").value),
            date: formattedDate,
            time: formattedTime,
            timestamp: timestamp // ‡πÄ‡∏û‡∏¥‡πà‡∏° timestamp ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á
        };

        try {
            if (editingId) {
                const billRef = doc(db, "bills", editingId);
                await updateDoc(billRef, billData);
                alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! (Firestore)");
            } else {
                await addDoc(billsCollection, billData);
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! (Firestore)");
            }
        } catch (e) {
            console.error("Error saving/updating document: ", e);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        }

        document.getElementById("bill-form").reset();
        document.getElementById("bill-form").style.display = "none";
        document.querySelector("#bill-form button[type='submit']").textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•";
        displayBills(); // ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏¥‡∏•‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    }

    // 6. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Firestore)
    window.displayBills = async function(filterPrice = null) {
        const display = document.getElementById("bills-display");
        display.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏¥‡∏•...';

        try {
            const q = query(billsCollection, orderBy("timestamp", "desc")); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            const querySnapshot = await getDocs(q);
            let bills = [];
            querySnapshot.forEach((doc) => {
                const bill = doc.data();
                bill.id = doc.id; // ‡πÄ‡∏Å‡πá‡∏ö Document ID ‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö
                bills.push(bill);
            });

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            const filteredBills = filterPrice !== null
                ? bills.filter(b => parseFloat(b.rent) === filterPrice)
                : bills;

            if (filteredBills.length === 0) {
                display.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏¥‡∏•</p>";
            } else {
                display.innerHTML = '';
                filteredBills.forEach((bill) => {
                    const electricCost = bill.electric * 8;
                    const total = (
                        bill.rent +
                        bill.water +
                        electricCost +
                        bill.cleaning +
                        bill.other
                    ).toFixed(2);

                    const html = `
                        <div class="bill-item" id="bill-${bill.id}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <h2 style="margin: 0; color: #2575fc;">‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>
                                    <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${bill.date} ‡πÄ‡∏ß‡∏•‡∏≤:${bill.time} ‡∏ô.<br/>
                                </div>
                                <div style="text-align: right; font-size: 0.85rem;">
                                    23 ‡∏´‡∏°‡∏π‡πà 9 ‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏à‡∏£‡∏¥‡∏ç ‡∏ï.‡∏ò‡∏≤‡∏ï‡∏∏ ‡∏≠.‡∏ß‡∏≤‡∏£‡∏¥‡∏ô‡∏ä‡∏≥‡∏£‡∏≤‡∏ö <br/>
                                    ‡∏à.‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå 34190 <br/>
                                    ‡πÇ‡∏ó‡∏£. 0865825196<br/>
                                    ID Line: pitchysu
                                </div>
                            </div>
                            <hr/>
                            <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤:</strong> ${bill.tenant}<br/>
                            <strong>‡∏´‡πâ‡∏≠‡∏á:</strong> ${bill.room}<br/>
                            <strong>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤:</strong> ${bill.rent} ‡∏ö‡∏≤‡∏ó<br/>
                            <strong>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥:</strong> ${bill.water} ‡∏ö‡∏≤‡∏ó<br/>
                            <strong>‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (${bill.electric} ‡∏´‡∏ô‡πà‡∏ß‡∏¢):</strong> ${electricCost} ‡∏ö‡∏≤‡∏ó<br/>
                            <strong>‡∏Ñ‡πà‡∏≤‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î:</strong> ${bill.cleaning} ‡∏ö‡∏≤‡∏ó<br/>
                            <strong>‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ:</strong> ${bill.other} ‡∏ö‡∏≤‡∏ó<br/>
                            <strong>‡∏£‡∏ß‡∏°:</strong> ${total} ‡∏ö‡∏≤‡∏ó
                            
                            <div style="margin-top: 10px; font-size: 0.85rem; color: #555;">
                                <em>
                                    ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5 ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô...
                                </em>
                            </div>

                            <div class="bill-buttons">
                                <button class="small-button" onclick="editBill('${bill.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button class="small-button" onclick="saveAsImage('bill-${bill.id}')">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ</button>
                                <button class="small-button" onclick="deleteBill('${bill.id}')">üóëÔ∏è ‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ</button>
                            </div>
                        </div>
                    `;
                    display.innerHTML += html;
                });

                display.innerHTML += `
                    <div class="clear-button">
                        <button class="small-button" onclick="clearBills()">‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                `;
            }

            display.style.display = "block";
            return bills; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ bills ‡∏ó‡∏µ‡πà‡∏°‡∏µ ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô
        } catch (e) {
            console.error("Error getting documents: ", e);
            display.innerHTML = "<p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏¥‡∏•</p>";
            return [];
        }
    }

    // 7. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏¥‡∏• (‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore ‡∏î‡πâ‡∏ß‡∏¢ ID)
    window.editBill = async function(id) {
        try {
            const docRef = doc(db, "bills", id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const bill = docSnap.data();
              console.log("‚úîÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡πÑ‡∏î‡πâ:", bill); // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
                document.getElementById("room").value = bill.room;
                document.getElementById("tenant").value = bill.tenant;
                document.getElementById("rent").value = bill.rent;
                document.getElementById("water").value = bill.water;
                document.getElementById("electric").value = bill.electric;
                document.getElementById("cleaning").value = bill.cleaning;
                document.getElementById("other").value = bill.other;

                editingId = id; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î ID ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

                document.getElementById("bill-form").style.display = "block";
                document.getElementById("bills-display").style.display = "none";
                document.querySelector("#bill-form button[type='submit']").textContent = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏¥‡∏•";
            } else {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç");
            }
        } catch (e) {
            console.error("Error editing document: ", e);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•");
        }
    }

    // 8. ‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÉ‡∏ä‡πâ ID)
    window.deleteBill = async function(id) {
        if (confirm("‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            try {
                await deleteDoc(doc(db, "bills", id));
                alert("‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! (Firestore)");
                displayBills();
            } catch (e) {
                console.error("Error deleting document: ", e);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏¥‡∏•");
            }
        }
    }

    // 9. ‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢! ‡∏•‡∏ö‡∏ó‡∏∏‡∏Å Document ‡πÉ‡∏ô Collection)
    window.clearBills = async function() {
        if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå")) {
            try {
                const querySnapshot = await getDocs(billsCollection);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
                alert("‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß! (Firestore)");
                displayBills();
            } catch (e) {
                console.error("Error clearing documents: ", e);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");
            }
        }
    }

    // 10. ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ displayBills ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô)
    window.compareElectricity = async function() {
        document.getElementById("bill-form").style.display = "none";
        const display = document.getElementById("bills-display");
        display.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

        const bills = await displayBills(null); // ‡∏î‡∏∂‡∏á‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        
        if (bills.length < 2) {
             display.innerHTML = "<p>‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ö‡∏¥‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</p>";
             display.style.display = "block";
             return;
        }

        const roomGroups = {};
        bills.forEach(bill => {
            if (!roomGroups[bill.room]) {
                roomGroups[bill.room] = [];
            }
            roomGroups[bill.room].push(bill);
        });

        let html = "<h3>‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏¥‡∏•)</h3>";
        let hasComparison = false;

        for (const room in roomGroups) {
            const group = roomGroups[room].sort((a, b) => a.timestamp - b.timestamp); // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
            if (group.length < 2) continue;

            hasComparison = true;
            html += `<h4>‡∏´‡πâ‡∏≠‡∏á ${room}</h4><ul>`;
            
            for (let i = 0; i < group.length; i++) {
                const bill = group[i];
                const electricCost = bill.electric * 8;
                let usageComparison = "";

                if (i > 0) {
                    const prevBill = group[i - 1];
                    const diff = bill.electric - prevBill.electric;
                    usageComparison = ` (‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô: ${diff} ‡∏´‡∏ô‡πà‡∏ß‡∏¢)`;
                }

                html += `<li>
                    <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${bill.date} |¬†
                    <strong>‡πÉ‡∏ä‡πâ‡πÑ‡∏ü:</strong> ${bill.electric} ‡∏´‡∏ô‡πà‡∏ß‡∏¢ |¬†
                    <strong>‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü:</strong> ${electricCost} ‡∏ö‡∏≤‡∏ó${usageComparison}
                </li>`;
            }
            html += `</ul>`;
        }

        if (!hasComparison) {
            html += "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</p>";
        }

        display.innerHTML = html;
        display.style.display = "block";
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveAsImage ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö DOM
    window.saveAsImage = function(id) {
        const element = document.getElementById(id);

        const buttons = element.querySelectorAll(".bill-buttons");
        buttons.forEach(btn => btn.style.display = "none");

        html2canvas(element).then(canvas => {
            const link = document.createElement("a");
            link.download = `${id}.png`;
            link.href = canvas.toDataURL();
            link.click();

            buttons.forEach(btn => btn.style.display = "flex");
        });
    }

</script>
  
</body>
</html>



