<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏¥‡∏•‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤ (‡∏´‡∏•‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)</title>
    <!-- Firebase CDN Imports -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- HTML2Canvas for image export -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f8; /* Soft background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better scrolling */
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .gui-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px 40px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            text-align: center;
            max-width: 650px;
            width: 100%;
            color: #333;
            margin-top: 20px;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #2575fc;
            font-weight: 700;
        }

        p.description {
            font-size: 1rem;
            margin-bottom: 1.5rem;
            color: #555;
        }

        .button-container, .small-button-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .price-button {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(37, 117, 252, 0.4);
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .price-button:hover {
            background: linear-gradient(135deg, #2575fc, #6a11cb);
            transform: translateY(-2px);
        }

        .small-button {
            background-color: #2575fc;
            border: none;
            border-radius: 8px;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(37, 117, 252, 0.3);
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .small-button:hover {
            background-color: #1a54b8;
            transform: translateY(-1px);
        }

        #bill-form {
            display: none;
            text-align: left;
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }

        #bill-form input, #bill-form select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        #bill-form button[type='submit'] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
        }

        #bills-display {
            text-align: left;
            margin-top: 20px;
            display: none;
            max-height: 400px;
            overflow-y: auto;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }

        .bill-item {
            background: #ffffff;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #eee;
        }
        
        .bill-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .bill-details {
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .bill-address {
            text-align: right;
            font-size: 0.75rem;
            color: #777;
        }

        .bill-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }
        
        /* Modal for alerts/confirms */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .gui-container {
                padding: 20px;
            }
            .button-container, .small-button-container {
                gap: 8px;
            }
            .price-button {
                flex-grow: 1;
                padding: 10px 12px;
                min-width: unset;
            }
            .bill-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            .bill-address {
                text-align: center;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="gui-container">
        <h1>‡∏£‡∏∞‡∏ö‡∏ö ‡∏ö‡∏¥‡∏•‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤</h1>
        <p class="description">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ô Firebase Cloud ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡πÑ‡∏î‡πâ</p>

        <div class="button-container">
            <button type="button" class="price-button" onclick="filterByRent(1600)">1600 ‡∏ö‡∏≤‡∏ó</button>
            <button type="button" class="price-button" onclick="filterByRent(1800)">1800 ‡∏ö‡∏≤‡∏ó</button>
            <button type="button" class="price-button" onclick="filterByRent(2000)">2000 ‡∏ö‡∏≤‡∏ó</button>
            <button type="button" class="price-button" onclick="filterByRent(2200)">2200 ‡∏ö‡∏≤‡∏ó</button>
            <button type="button" class="price-button" onclick="filterByRent(2500)">2500 ‡∏ö‡∏≤‡∏ó</button>
            <button type="button" class="price-button" onclick="filterByRent(3000)">3000 ‡∏ö‡∏≤‡∏ó</button>
            <button type="button" class="price-button" onclick="filterByRent(3500)">3500 ‡∏ö‡∏≤‡∏ó</button>
        </div>

        <div class="small-button-container">
            <button type="button" class="small-button" onclick="showForm()">‡∏Å‡∏£‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡∏´‡∏≠‡∏û‡∏±‡∏Å</button>
            <button type="button" class="small-button" onclick="showBills()">‡∏î‡∏π‡∏ö‡∏¥‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</button>
            <button type="button" class="small-button" onclick="compareElectricity()">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü</button>
        </div>

        <form id="bill-form" onsubmit="saveBill(event)">
            <input type="text" id="room" placeholder="‡∏´‡πâ‡∏≠‡∏á" required />
            <input type="text" id="tenant" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤" required />
            <input type="number" id="rent" placeholder="‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á (‡∏ö‡∏≤‡∏ó)" required />
            <input type="number" id="water" placeholder="‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ (‡∏ö‡∏≤‡∏ó)" required />
            <input type="number" id="electric" placeholder="‡πÉ‡∏ä‡πâ‡πÑ‡∏ü (‡∏´‡∏ô‡πà‡∏ß‡∏¢)" required />
            <input type="number" id="cleaning" placeholder="‡∏Ñ‡πà‡∏≤‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î" value="0" required />
            <input type="number" id="other" placeholder="‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ" value="0" required />
            <button type="submit" class="small-button" id="submit-button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•</button>
        </form>

        <div id="bills-display"></div>
    </div>
    
    <!-- Custom Modal UI for alerts and confirms -->
    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <p id="modal-message"></p>
            <div class="modal-buttons">
                <button class="small-button" id="modal-confirm" style="display: none;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                <button class="small-button" id="modal-cancel">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Configuration and Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyA3cyOB17I-p-PGgUCSduXgwsREajZBSiU",
            authDomain: "bill-puttharaksa.firebaseapp.com",
            projectId: "bill-puttharaksa",
            storageBucket: "bill-puttharaksa.firebasestorage.app",
            messagingSenderId: "645837893122",
            appId: "1:645837893122:web:cce76dbff19d960c33811b",
            measurementId: "G-X0EWMS7H3J"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const billsRef = database.ref('bills'); // Collection Reference
        
        let editingKey = null; // Stores the Firebase key of the bill being edited

        // --- Custom Modal Functions (Replacing alert and confirm) ---
        function showPrompt(message, isConfirm = false) {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-modal');
                const msg = document.getElementById('modal-message');
                const btnConfirm = document.getElementById('modal-confirm');
                const btnCancel = document.getElementById('modal-cancel');

                msg.textContent = message;
                modal.style.display = 'flex';
                
                // Reset listeners
                btnConfirm.onclick = null;
                btnCancel.onclick = null;

                if (isConfirm) {
                    btnCancel.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
                    btnConfirm.style.display = 'inline-block';
                    btnConfirm.onclick = () => {
                        modal.style.display = 'none';
                        resolve(true);
                    };
                    btnCancel.onclick = () => {
                        modal.style.display = 'none';
                        resolve(false);
                    };
                } else {
                    btnCancel.textContent = '‡∏ï‡∏Å‡∏•‡∏á';
                    btnConfirm.style.display = 'none';
                    btnCancel.onclick = () => {
                        modal.style.display = 'none';
                        resolve(true); // Always resolve true for simple alerts
                    };
                }
            });
        }

        // --- Core UI Functions ---

        function showForm() {
            document.getElementById("bill-form").reset();
            editingKey = null;
            document.getElementById("submit-button").textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•";
            document.getElementById("bill-form").style.display = "block";
            document.getElementById("bills-display").style.display = "none";
        }

        function showBills() {
            document.getElementById("bill-form").style.display = "none";
            displayBills();
        }

        function filterByRent(price) {
            displayBills(price);
        }
        
        // --- Firebase Data Functions ---

        async function saveBill(event) {
            event.preventDefault();
            
            const today = new Date();
            const formattedDate = today.toLocaleDateString('th-TH', { year: 'numeric', month: '2-digit', day: '2-digit' });
            const formattedTime = today.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

            const bill = {
                room: document.getElementById("room").value,
                tenant: document.getElementById("tenant").value,
                rent: parseFloat(document.getElementById("rent").value) || 0,
                water: parseFloat(document.getElementById("water").value) || 0,
                electric: parseFloat(document.getElementById("electric").value) || 0,
                cleaning: parseFloat(document.getElementById("cleaning").value) || 0,
                other: parseFloat(document.getElementById("other").value) || 0,
                date: formattedDate,
                time: formattedTime,
                timestamp: firebase.database.ServerValue.TIMESTAMP // Useful for sorting
            };

            const submitButton = document.getElementById("submit-button");
            submitButton.disabled = true;

            try {
                if (editingKey) {
                    // Update existing bill
                    await billsRef.child(editingKey).set(bill);
                    await showPrompt("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
                } else {
                    // Save new bill
                    await billsRef.push(bill);
                    await showPrompt("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
                }
            } catch (error) {
                console.error("Error saving/updating bill: ", error);
                await showPrompt("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + error.message);
            } finally {
                submitButton.disabled = false;
                document.getElementById("bill-form").reset();
                document.getElementById("bill-form").style.display = "none";
                document.getElementById("submit-button").textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•";
                showBills(); // Refresh list
            }
        }

        async function displayBills(filterPrice = null) {
            const display = document.getElementById("bills-display");
            display.innerHTML = '<p style="text-align: center; color: #2575fc;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏¥‡∏•‡∏à‡∏≤‡∏Å Firebase...</p>';
            display.style.display = "block";

            try {
                const snapshot = await billsRef.once('value');
                const billsData = snapshot.val();
                let bills = [];

                if (billsData) {
                    // Convert object of bills into an array, including the Firebase key (id)
                    bills = Object.keys(billsData).map(key => ({
                        id: key, 
                        ...billsData[key]
                    }));
                    // Sort by timestamp descending (newest first)
                    bills.sort((a, b) => b.timestamp - a.timestamp);
                }
                
                const filteredBills = filterPrice !== null
                    ? bills.filter(b => parseFloat(b.rent) === filterPrice)
                    : bills;

                display.innerHTML = ''; // Clear loading message

                if (filteredBills.length === 0) {
                    display.innerHTML = "<p style='text-align: center;'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏¥‡∏•</p>";
                } else {
                    filteredBills.forEach((bill) => {
                        const electricCost = (bill.electric * 8).toFixed(2);
                        const total = (
                            parseFloat(bill.rent) +
                            parseFloat(bill.water) +
                            parseFloat(electricCost) +
                            parseFloat(bill.cleaning) +
                            parseFloat(bill.other)
                        ).toFixed(2);

                        const html = `
                            <div class="bill-item" id="bill-${bill.id}">
                                <div class="bill-header">
                                    <div>
                                        <h2 style="margin: 0; color: #2575fc; font-size: 1.5rem;">‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏Å‡∏©‡∏≤</h2>
                                        <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${bill.date} ‡πÄ‡∏ß‡∏•‡∏≤:${bill.time} ‡∏ô.<br/>
                                    </div>
                                    <div class="bill-address">
                                        23 ‡∏´‡∏°‡∏π‡πà 9 ‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏à‡∏£‡∏¥‡∏ç ‡∏ï.‡∏ò‡∏≤‡∏ï‡∏∏ ‡∏≠.‡∏ß‡∏≤‡∏£‡∏¥‡∏ô‡∏ä‡∏≥‡∏£‡∏≤‡∏ö <br/>
                                        ‡∏à.‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå 34190 <br/>
                                        ‡πÇ‡∏ó‡∏£. 0865825196 | ID Line: pitchysu
                                    </div>
                                </div>
                                <hr style="margin: 10px 0; border-color: #f0f0f0;"/>
                                <div class="bill-details">
                                    <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤:</strong> ${bill.tenant}<br/>
                                    <strong>‡∏´‡πâ‡∏≠‡∏á:</strong> ${bill.room}<br/>
                                    <strong>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤:</strong> ${bill.rent} ‡∏ö‡∏≤‡∏ó<br/>
                                    <strong>‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥:</strong> ${bill.water} ‡∏ö‡∏≤‡∏ó<br/>
                                    <strong>‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (${bill.electric} ‡∏´‡∏ô‡πà‡∏ß‡∏¢ @ 8 ‡∏ö‡∏≤‡∏ó):</strong> ${electricCost} ‡∏ö‡∏≤‡∏ó<br/>
                                    <strong>‡∏Ñ‡πà‡∏≤‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î:</strong> ${bill.cleaning} ‡∏ö‡∏≤‡∏ó<br/>
                                    <strong>‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ:</strong> ${bill.other} ‡∏ö‡∏≤‡∏ó<br/>
                                    <h3 style="margin: 10px 0 0; color: #6a11cb; font-size: 1.2rem;">‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞: ${total} ‡∏ö‡∏≤‡∏ó</h3>
                                </div>
                                
                                <div style="margin-top: 15px; font-size: 0.8rem; color: #777; border-top: 1px dashed #ddd; padding-top: 10px;">
                                    <em>
                                        ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5 ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br/>
                                        ‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5 ‡∏õ‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 20 ‡∏ö‡∏≤‡∏ó | ‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 15 ‡∏õ‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 50 ‡∏ö‡∏≤‡∏ó<br/>
                                        ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡∏ò. ‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ ‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÇ‡∏•‡∏ï‡∏±‡∏™‡∏ß‡∏≤‡∏£‡∏¥‡∏ô‡∏ä‡∏≥‡∏£‡∏≤‡∏ö ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 393-0-37364-5 ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡∏ô‡∏≤‡∏á‡∏û‡∏¥‡∏ä‡∏ç‡∏≤‡∏†‡∏£‡∏ì‡πå ‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏Å‡∏π‡∏è<br/>
                                        ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå 0865825196 ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏á‡∏û‡∏¥‡∏ä‡∏ç‡∏≤‡∏†‡∏£‡∏ì‡πå ‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏Å‡∏π‡∏è
                                    </em>
                                </div>

                                <div class="bill-buttons">
                                    <button class="small-button" onclick="editBill('${bill.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                    <button class="small-button" onclick="saveAsImage('bill-${bill.id}')">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ</button>
                                    <button class="small-button" onclick="deleteBill('${bill.id}')">üóëÔ∏è ‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ</button>
                                </div>
                            </div>
                        `;
                        display.innerHTML += html;
                    });

                    display.innerHTML += `
                        <div style="text-align: right; margin-top: 20px;">
                            <button class="small-button" onclick="clearBills()">‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‚ö†Ô∏è ‡∏•‡∏ö‡∏à‡∏≤‡∏Å Cloud)</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error("Error fetching bills: ", error);
                display.innerHTML = "<p style='text-align: center; color: red;'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase</p>";
            }
        }

        async function editBill(key) { 
            document.getElementById("bills-display").style.display = "none";
            document.getElementById("bill-form").style.display = "block";
            document.getElementById("submit-button").textContent = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏¥‡∏•";

            try {
                const snapshot = await billsRef.child(key).once('value');
                const bill = snapshot.val();
                
                if (bill) {
                    document.getElementById("room").value = bill.room;
                    document.getElementById("tenant").value = bill.tenant;
                    document.getElementById("rent").value = bill.rent;
                    document.getElementById("water").value = bill.water;
                    document.getElementById("electric").value = bill.electric;
                    document.getElementById("cleaning").value = bill.cleaning;
                    document.getElementById("other").value = bill.other;

                    editingKey = key; // Set the key for updating
                } else {
                    await showPrompt("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç");
                    showBills();
                }
            } catch (error) {
                console.error("Error fetching bill for edit: ", error);
                await showPrompt("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•: " + error.message);
                showBills();
            }
        }

        async function deleteBill(key) {
            const confirmed = await showPrompt("‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£", true);
            if (confirmed) {
                try {
                    await billsRef.child(key).remove();
                    await showPrompt("‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
                    displayBills();
                } catch (error) {
                    console.error("Error removing bill: ", error);
                    await showPrompt("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏¥‡∏•: " + error.message);
                }
            }
        }

        async function clearBills() {
            const confirmed = await showPrompt("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Cloud ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£!", true);
            if (confirmed) {
                try {
                    await billsRef.remove();
                    await showPrompt("‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!");
                    displayBills();
                } catch (error) {
                    console.error("Error clearing bills: ", error);
                    await showPrompt("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•: " + error.message);
                }
            }
        }

        async function compareElectricity() {
            document.getElementById("bill-form").style.display = "none";
            const display = document.getElementById("bills-display");
            display.innerHTML = '<p style="text-align: center; color: #2575fc;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö...</p>';

            try {
                const snapshot = await billsRef.once('value');
                const billsData = snapshot.val();
                let bills = [];
                
                if (billsData) {
                    bills = Object.keys(billsData).map(key => ({ id: key, ...billsData[key] }));
                }

                if (bills.length < 2) {
                    display.innerHTML = "<p style='text-align: center;'>‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ö‡∏¥‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</p>";
                    display.style.display = "block";
                    return;
                }

                const roomGroups = {};
                bills.forEach(bill => {
                    if (!roomGroups[bill.room]) {
                        roomGroups[bill.room] = [];
                    }
                    roomGroups[bill.room].push(bill);
                });

                let html = "<h3>‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏¥‡∏•)</h3>";
                let hasComparison = false;

                for (const room in roomGroups) {
                    const group = roomGroups[room].sort((a, b) => a.timestamp - b.timestamp);
                    if (group.length < 2) continue;

                    hasComparison = true;
                    html += `<h4 style="margin-top: 15px; color: #6a11cb;">‡∏´‡πâ‡∏≠‡∏á ${room}</h4><ul style="list-style: none; padding-left: 0;">`;
                    group.forEach(bill => {
                        const electricCost = (bill.electric * 8).toFixed(2);
                        html += `<li style="padding: 5px 0; border-bottom: 1px dotted #eee;">
                            <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${bill.date} | 
                            <strong>‡πÉ‡∏ä‡πâ‡πÑ‡∏ü:</strong> ${bill.electric} ‡∏´‡∏ô‡πà‡∏ß‡∏¢ | 
                            <strong>‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü:</strong> ${electricCost} ‡∏ö‡∏≤‡∏ó
                        </li>`;
                    });
                    html += `</ul>`;
                }

                if (!hasComparison) {
                    html += "<p style='text-align: center;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</p>";
                }

                display.innerHTML = html;
                display.style.display = "block";

            } catch (error) {
                console.error("Error comparing electricity: ", error);
                display.innerHTML = "<p style='text-align: center; color: red;'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</p>";
            }
        }
        
        // --- Utility Functions ---

        function saveAsImage(id) {
            const element = document.getElementById(id);

            // Temporarily hide buttons for the screenshot
            const buttons = element.querySelectorAll(".bill-buttons");
            buttons.forEach(btn => btn.style.display = "none");

            html2canvas(element, { scale: 2, allowTaint: true, useCORS: true }).then(canvas => {
                const link = document.createElement("a");
                link.download = `bill-${id}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                // Restore buttons
                buttons.forEach(btn => btn.style.display = "flex");
            });
        }
    </script>
</body>
</html>
